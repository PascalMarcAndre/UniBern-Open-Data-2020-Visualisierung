<!DOCTYPE html>
<html lang="de">
<head>
	<title>Tarifverbünde in der Schweiz - Analyse zu Kurzstrecken</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="leaflet/leaflet.css">
    <link rel="stylesheet" href="custom/custom.css">

    <script src="leaflet/leaflet.js"></script>
    <script src="d3/d3.v4.min.js"></script>
    <script src="d3/d3-sparql.min.js"></script>
    <script src="custom/custom.js"></script>
</head>
<body>



<div id="mapid" style="width: 600px; height: 400px;"></div>
<script>

var allStops = `PREFIX sc: <http://purl.org/science/owl/sciencecommons/>
PREFIX gtfs: <http://vocab.gtfs.org/terms#>
PREFIX schema: <http://schema.org/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX otd: <http://lod.opentransportdata.swiss/vocab/> PREFIX dcterms: <http://purl.org/dc/terms/>
SELECT distinct ?Station ?Name ?Coord ?departureID
WHERE {
?Kante a otd:Relation; otd:zoningPlan
<http://lod.opentransportdata.swiss/zoningplan/libero/libero-billett-libero>; schema:departureStation ?Station .
?Station rdfs:label ?Name ;
<http://www.opengis.net/ont/geosparql#hasGeometry>/<http://www.opengis.net/ont/geosparql#asWKT> ?Coord;              dcterms:identifier ?departureID .
} 
limit 10000
`
function shortdistance(ID){
return `PREFIX schema: <http://schema.org/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX otd: <http://lod.opentransportdata.swiss/vocab/> PREFIX dcterms: <http://purl.org/dc/terms/>
SELECT ?departure ?departureCoord ?departureID ?arrival ?arrivalCoord ?arrivalID
WHERE {
?Kante a otd:Relation; otd:zoningPlan
<http://lod.opentransportdata.swiss/zoningplan/libero/libero-billett-libero>; schema:departureStation ?departurePoint ; schema:arrivalStation ?arrivalPoint .
?departurePoint rdfs:label ?departure ;
<http://www.opengis.net/ont/geosparql#hasGeometry>/<http://www.opengis.
net/ont/geosparql#asWKT> ?departureCoord;              dcterms:identifier ?departureID .
?arrivalPoint rdfs:label ?arrival ;
<http://www.opengis.net/ont/geosparql#hasGeometry>/<http://www.opengis.
net/ont/geosparql#asWKT> ?arrivalCoord;                   dcterms:identifier ?arrivalID. 
FILTER(?departurePoint IN  
(<http://lod.opentransportdata.swiss/didok/`+ ID + `>))
} 
limit 100
`
}

lindasURL = 'https://lindas.admin.ch/query'
depatureIDs = [];
/*
    All Stops included as Markers
*/
d3.sparql(lindasURL, allStops).then((data) => {
    
    for (var i = 0; i < data.length; i++)
        depatureIDs.push(data[i].departureID),
        CoordX = data[i].Coord.replace("POINT(", "").replace(")", "").split(' ')[0],
        CoordY = data[i].Coord.replace("POINT(", "").replace(")", "").split(' ')[1],

        L.marker([CoordY, CoordX])
        .addTo(mymap).bindPopup(data[i].Name),
        
        //short distance from All station
        //TODO not working yet
        d3.sparql(lindasURL, shortdistance(data[i].departureID)).then((d) => {
        for (var i = 0; i < d.length; i++)
        console.log(d[i])})

    })

    
	var mymap = L.map('mapid').setView([46.951572, 7.44976], 13);

	L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox/streets-v11',
		tileSize: 512,
		zoomOffset: -1
	}).addTo(mymap);


	var popup = L.popup();

	function onMapClick(e) {
		popup
			.setLatLng(e.latlng)
			.setContent("You clicked the map at " + e.latlng.toString())
			.openOn(mymap);
	}

	mymap.on('click', onMapClick);

</script>


</body>
</html>


